<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Staff Tracker Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet Map JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet.draw Plugin for Geofencing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- OSM Buildings (3D buildings overlay) -->
    <script src="https://cdn.osmbuildings.org/OSMBuildings-Latest.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        #map { /* Apply height only to the main map */
            height: 100%;
        }
        #map-container { /* Main map container */
            height: 100vh;
            position: relative; /* Needed for absolute positioning */
        }
        
        /* Custom scrollbar for sidebar/modal sections */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        
        /* Leaflet marker customization */
        .staff-marker-label {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #94a3b8; /* gray-400 */
            color: #1e293b; /* gray-800 */
            font-weight: 700;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.25);
            pointer-events: none; /* labels don‚Äôt block clicks on markers */
            padding: 2px 6px;
            border-radius: 4px;
        }
        /* Class for clickable staff card */
        .staff-card-clickable {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .staff-card-clickable:hover {
            background-color: #374151; /* gray-700 */
        }
        /* Geofence Alert Flash - This is the "problem" state (OUTSIDE) */
        @keyframes pulse-red {
            0%, 100% {
                background-color: #7f1d1d; /* red-900 */
                border-color: #ef4444; /* red-500 */
            }
            50% {
                background-color: #1f2937; /* gray-800 */
                border-color: #4b5563; /* gray-600 */
            }
        }
        .geofence-alert {
            animation: pulse-red 1.5s infinite;
        }

        /* Sidebar Card Highlight */
        @keyframes highlight-blue {
            0%, 100% { background-color: #1f2937; } /* gray-800 */
            50% { background-color: #1d4ed8; } /* blue-700 */
        }
        .card-highlight {
            animation: highlight-blue 1.5s ease-in-out;
        }

        /* Hide Leaflet.draw toolbar */
        .leaflet-draw-toolbar {
            display: none;
        }
        /* Geofence Assignment List */
        .geofence-staff-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem; /* p-2 */
            background-color: #374151; /* gray-700 */
        }
        /* Location text style */
        .location-text {
            font-size: 0.8rem; /* text-xs */
            color: #d1d5db; /* gray-300 */
            font-style: italic;
        }
        .location-text button {
            color: #93c5fd; /* blue-300 */
            text-decoration: underline;
            font-style: normal;
        }
        .location-text button:hover {
            color: #bfdbfe; /* blue-200 */
        }
        
        /* Style for date/select inputs */
        input[type="date"]::-webkit-calendar-picker-indicator,
        select {
             filter: invert(0.8); /* Make icons visible on dark background */
        }
        select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 0.5rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
             padding-right: 2.5rem;
             -webkit-appearance: none;
             -moz-appearance: none;
             appearance: none;
        }
        
        /* Search Bar Styles */
        #search-container {
            position: absolute;
            top: 1rem; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000; 
            width: 90%;
            max-width: 400px;
        }
        #search-input {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid #4b5563; border-radius: 0.375rem; background-color: #1f2937; color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        #search-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        #search-results {
            position: absolute; top: calc(100% + 0.25rem); left: 0; right: 0; background-color: #1f2937; border: 1px solid #4b5563; border-radius: 0.375rem; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); z-index: 999;
        }
        #search-results div { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 1px solid #374151; }
        #search-results div:last-child { border-bottom: none; }
        #search-results div:hover { background-color: #374151; }
        #search-results .staff-details { font-size: 0.75rem; color: #9ca3af; }
        
        /* Filter Icon Button */
        #filter-icon-btn {
            position: absolute;
            top: 1rem; /* 16px */
            right: 1rem; /* 16px */
            z-index: 1000;
            padding: 0.5rem; /* p-2 */
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.375rem; /* rounded-md */
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        #filter-icon-btn:hover {
            background-color: #374151; /* gray-700 */
            color: white;
        }
        #filter-icon-btn.active { /* Style when filters are applied */
            background-color: #1d4ed8; /* blue-700 */
            color: white;
            border-color: #1d4ed8;
        }
         #filter-icon-btn svg {
             width: 1.25rem; /* w-5 */
             height: 1.25rem; /* h-5 */
         }

        /* Clear History Path Button */
        #clear-path-btn {
            position: absolute;
            top: 1rem; /* 16px */
            right: 5.5rem; /* slightly left of filter button */
            z-index: 1000;
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.375rem; /* rounded-md */
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        #clear-path-btn:hover {
            background-color: #374151; /* gray-700 */
            color: white;
        }

        /* Filter Modal Styles */
        #filter-modal .filter-section {
            margin-bottom: 1rem; /* mb-4 */
            padding-bottom: 1rem; /* pb-4 */
            border-bottom: 1px solid #4b5563; /* border-b border-gray-600 */
        }
        #filter-modal .filter-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        #filter-modal h3 {
            font-size: 1rem; /* text-base */
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.5rem; /* mb-2 */
            color: #e5e7eb; /* gray-200 */
        }
        #filter-modal .checkbox-list {
            max-height: 150px; /* Adjust as needed */
            overflow-y: auto;
            padding: 0.5rem; /* p-2 */
            border: 1px solid #4b5563; /* border border-gray-600 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: #374151; /* bg-gray-700 */
            space-y: 0.25rem; /* space-y-1 */
        }
         #filter-modal label {
             display: flex;
             align-items: center;
             cursor: pointer;
             color: #d1d5db; /* gray-300 */
             font-size: 0.875rem; /* text-sm */
             user-select: none; /* Prevent text selection on click */
         }
         #filter-modal input[type="checkbox"] {
             margin-right: 0.5rem; /* mr-2 */
             height: 1rem; /* h-4 */
             width: 1rem; /* w-4 */
             border-radius: 0.25rem; /* rounded */
             border-color: #6b7280; /* border-gray-500 */
             background-color: #4b5563; /* bg-gray-600 */
             color: #6366f1; /* text-indigo-600 */
             focus:ring-indigo-500;
         }
         #filter-modal label.disabled {
             color: #6b7280; /* gray-500 */
             cursor: not-allowed;
             opacity: 0.6;
         }
         #filter-modal input[type="checkbox"]:disabled {
             opacity: 0.5;
         }

         /* Day Report Modal List */
         #day-report-list {
             max-height: 300px;
             overflow-y: auto;
             border: 1px solid #4b5563;
             border-radius: 0.375rem;
             padding: 0.5rem;
             background-color: #1f2937; /* gray-800 */
         }
         #day-report-list p {
             padding: 0.25rem 0.5rem;
             border-bottom: 1px solid #374151; /* gray-700 */
         }
         #day-report-list p:last-child {
             border-bottom: none;
         }
        
    </style>
</head>
<body class="bg-gray-800 text-white">

    <!-- Login Page (Hidden after authentication) -->
    <div id="login-page" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-[10000]">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h1 class="text-3xl font-bold text-center text-white mb-8">Staff Tracker</h1>
            
            <div class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-300">Email</label>
                    <input type="email" id="login-email" placeholder="admin@example.com" 
                        class="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                    <div class="relative">
                        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                            class="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <button type="button" id="toggle-password" class="absolute right-3 top-3 text-gray-400 hover:text-gray-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="login-error" class="hidden text-red-400 text-sm p-3 bg-red-900 rounded"></div>
                
                <button id="login-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium transition">
                    Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="flex relative h-screen">

        <!-- Sidebar -->
        <div class="w-96 h-full bg-gray-900 shadow-lg flex flex-col z-20">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex-shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-2xl font-bold text-white">Staff Tracker</h1>
                    <button id="logout-btn" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition">
                        Logout
                    </button>
                </div>
                <div id="connection-status" class="mt-2 text-sm font-medium text-center text-red-400">
                    Connecting to database...
                </div>
                <div id="admin-info" class="mt-1 text-xs text-center text-gray-400 hidden">
                    <!-- Admin name will appear here -->
                </div>
            </div>
            
            <!-- Add Staff Button -->
            <div id="add-staff-section" class="p-4 border-b border-gray-700 flex-shrink-0 hidden">
                <button id="open-add-staff-modal-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-medium">
                    + Add New Staff
                </button>
            </div>
            
            <!-- Admin Controls (visible only to Super Admin) -->
            <div id="admin-controls" class="p-4 border-b border-gray-700 flex-shrink-0 hidden">
                <button id="open-add-admin-modal-btn" class="w-full px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 font-medium mb-2">
                    + Add New Admin
                </button>
                <button id="open-manage-admins-btn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-medium mb-2">
                    üë• Manage Admins
                </button>
                <p class="mt-2 text-xs text-gray-400">Super Admin controls</p>
            </div>

            <!-- Geofence Section -->
            <div class="p-4 border-b border-gray-700 flex-shrink-0">
                <h2 class="text-lg font-semibold mb-2">Geofences</h2>
                <button id="create-geofence-btn" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 font-medium mb-3">
                    Create New Geofence (Circle)
                </button>
                <div id="geofence-list" class="custom-scroll max-h-32 overflow-y-auto space-y-2">
                    <p id="loading-geofences" class="text-gray-400">Loading geofences...</p>
                    <!-- Geofences will be listed here -->
                </div>
            </div>
            
            <!-- Staff List -->
            <div id="staff-list" class="custom-scroll flex-grow overflow-y-auto p-4 space-y-3">
                <!-- Staff cards will be injected here by JavaScript -->
                <p id="loading-staff" class="text-gray-400">Loading staff list...</p>
            </div>
        </div>

        <!-- Map Area -->
        <div id="map-container" class="flex-grow h-full">
            <!-- This div is the map container -->
            <div id="map" class="w-full h-full"></div>

            <!-- Search Bar Container -->
            <div id="search-container">
                <input type="text" id="search-input" placeholder="Search by Name, Phone, Company, Branch...">
                <div id="search-results" class="hidden">
                    <!-- Search results will appear here -->
                </div>
            </div>

            <!-- Filter Icon Button -->
            <button id="filter-icon-btn" title="Filter Staff View">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.572a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
                 </svg>
            </button>

            <!-- Clear History Path Button -->
            <button id="clear-path-btn" title="Hide History Path" class="hidden">‚úï Path</button>
        </div>
    </div>

    <!-- Add Staff Modal (Updated) -->
    <div id="add-staff-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9999] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg border border-gray-700">
            <h2 class="text-xl font-bold text-white mb-4">Add New Staff</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="new-staff-name" class="block text-sm font-medium text-gray-300">Name</label>
                        <input type="text" id="new-staff-name" placeholder="Staff's full name" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                    </div>
                    <div>
                        <label for="new-staff-phone" class="block text-sm font-medium text-gray-300">Phone Number (10 Digits)</label>
                        <input type="tel" id="new-staff-phone" placeholder="e.g., 9876543210" maxlength="10" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                    </div>
                </div>
                
                <div>
                    <label for="new-staff-company" class="block text-sm font-medium text-gray-300">Company</label>
                    <select id="new-staff-company" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                        <option value="">Select Company</option>
                        <option value="Toyota">Toyota</option>
                        <option value="Ather">Ather</option>
                        <option value="AMS">AMS</option>
                        <option value="Other">Other (Specify)</option>
                    </select>
                    <input type="text" id="new-staff-company-other" placeholder="Enter company name" class="mt-2 hidden w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                </div>
                
                <div>
                    <label for="new-staff-branch" class="block text-sm font-medium text-gray-300">Branch</label>
                    <select id="new-staff-branch" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                        <option value="">Select Branch</option>
                        <option value="Coimbatore">Coimbatore</option>
                        <option value="Erode">Erode</option>
                        <option value="Tiruppur">Tiruppur</option>
                        <option value="Mettupalayam">Mettupalayam</option>
                        <option value="Udumalpet">Udumalpet</option>
                        <option value="Dharapuram">Dharapuram</option>
                        <option value="Madampatti">Madampatti</option>
                        <option value="Pollachi">Pollachi</option>
                        <option value="Ooty">Ooty</option>
                        <option value="Kangayam">Kangayam</option>
                        <option value="Bhavani">Bhavani</option>
                        <option value="Other">Other (Specify)</option>
                    </select>
                    <input type="text" id="new-staff-branch-other" placeholder="Enter branch name" class="mt-2 hidden w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                </div>
                
                <div>
                    <label for="new-staff-dept" class="block text-sm font-medium text-gray-300">Department</label>
                    <select id="new-staff-dept" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                        <option value="">Select Department</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Eco Wash">Eco Wash</option>
                        <option value="Towing Service">Towing Service</option>
                        <option value="Driver Service">Driver Service</option>
                        <option value="BrakeDown Service">BrakeDown Service</option>
                        <option value="Other">Other (Specify)</option>
                    </select>
                    <input type="text" id="new-staff-dept-other" placeholder="Enter department name" class="mt-2 hidden w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-staff-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Cancel</button>
                <button id="add-staff-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Add Staff</button>
            </div>
        </div>
    </div>

    <!-- Add Admin Modal -->
    <div id="add-admin-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9999] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg border border-gray-700 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-white mb-4">Add New Admin</h2>
            <div class="space-y-4">
                <!-- Name -->
                <div>
                    <label for="new-admin-name" class="block text-sm font-medium text-gray-300">Name</label>
                    <input type="text" id="new-admin-name" placeholder="Admin's full name" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-blue-500">
                </div>
                
                <!-- Email -->
                <div>
                    <label for="new-admin-email" class="block text-sm font-medium text-gray-300">Email</label>
                    <input type="email" id="new-admin-email" placeholder="admin@example.com" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-blue-500">
                </div>
                
                <!-- Password -->
                <div>
                    <label for="new-admin-password" class="block text-sm font-medium text-gray-300">Password</label>
                    <input type="password" id="new-admin-password" placeholder="Minimum 6 characters" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-blue-500">
                    <p class="text-xs text-gray-400 mt-1">Creates metadata; user must be set up in Firebase Auth separately.</p>
                </div>
                
                <!-- Role -->
                <div>
                    <label for="new-admin-role" class="block text-sm font-medium text-gray-300">Role</label>
                    <select id="new-admin-role" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-blue-500">
                        <option value="master">Super Admin (Full Access)</option>
                        <option value="admin">Admin (Department Restricted)</option>
                    </select>
                </div>
                
                <!-- Departments (shown only for admin role) -->
                <div id="departments-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Assign Departments</label>
                    <div id="departments-checkboxes" class="space-y-2 max-h-40 overflow-y-auto p-2 bg-gray-700 rounded">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Select one or more departments for this admin.</p>
                </div>
                
                <!-- Permissions -->
                <div>
                    <h3 class="text-sm font-medium text-gray-300 mb-2">Permissions</h3>
                    <div class="grid grid-cols-2 gap-2 text-gray-200">
                        <label class="flex items-center space-x-2"><input type="checkbox" id="perm-add-staff" class="h-4 w-4 text-purple-600 rounded bg-gray-700"><span>Can Add Staff</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="perm-delete-staff" class="h-4 w-4 text-purple-600 rounded bg-gray-700"><span>Can Delete Staff</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="perm-edit-staff" class="h-4 w-4 text-purple-600 rounded bg-gray-700"><span>Can Edit Staff</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="perm-manage-geofence" class="h-4 w-4 text-purple-600 rounded bg-gray-700"><span>Can Manage Geofences</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="perm-manage-admins" class="h-4 w-4 text-purple-600 rounded bg-gray-700"><span>Can Manage Admins</span></label>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-admin-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Cancel</button>
                <button id="add-admin-btn" class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700">Add Admin</button>
            </div>
        </div>
    </div>

    <!-- Manage Admins Modal -->
    <div id="manage-admins-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9999] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-2xl border border-gray-700 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-white mb-4">Manage Admins</h2>
            
            <!-- Admin Search Bar -->
            <div class="mb-4">
                <input type="text" id="admin-search-input" placeholder="Search by name, email, or role..." class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <!-- Admin Filter Options -->
            <div class="mb-4 flex flex-wrap gap-2">
                <button id="filter-all-admins" class="admin-filter-btn px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" data-filter="all">All</button>
                <button id="filter-master-admins" class="admin-filter-btn px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-500" data-filter="master">Super Admins</button>
                <button id="filter-regular-admins" class="admin-filter-btn px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-500" data-filter="admin">Regular Admins</button>
            </div>
            
            <div id="admins-list" class="space-y-3 max-h-96 overflow-y-auto custom-scroll">
                <p class="text-gray-400">Loading admins...</p>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button id="close-manage-admins-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Admin Modal -->
    <div id="edit-admin-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9999] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg border border-gray-700 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-white mb-4">Edit Admin</h2>
            <input type="hidden" id="edit-admin-id">
            
            <div class="space-y-4">
                <div>
                    <label for="edit-admin-name" class="block text-sm font-medium text-gray-300">Name</label>
                    <input type="text" id="edit-admin-name" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300">Email (Username)</label>
                    <input type="email" id="edit-admin-email" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                    <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Changing email will affect login credentials</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300">Role</label>
                    <input type="text" id="edit-admin-role" disabled class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-600 text-gray-400" title="Role cannot be changed">
                </div>
                
                <!-- Password Reset Section -->
                <div class="border-t border-gray-600 pt-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-300">Reset Password</label>
                        <button type="button" id="toggle-password-reset" class="text-xs text-blue-400 hover:text-blue-300">Change Password</button>
                    </div>
                    <div id="password-reset-section" class="hidden space-y-3">
                        <div>
                            <label for="edit-admin-new-password" class="block text-xs text-gray-400">New Password</label>
                            <input type="password" id="edit-admin-new-password" placeholder="Minimum 6 characters" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white text-sm">
                        </div>
                        <div>
                            <label for="edit-admin-confirm-password" class="block text-xs text-gray-400">Confirm Password</label>
                            <input type="password" id="edit-admin-confirm-password" placeholder="Re-enter password" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white text-sm">
                        </div>
                        <p class="text-xs text-gray-400">üí° Leave blank to keep current password</p>
                    </div>
                </div>
                
                <div id="edit-departments-section">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Departments</label>
                    <div id="edit-departments-checkboxes" class="space-y-2 max-h-40 overflow-y-auto p-2 bg-gray-700 rounded"></div>
                </div>
                
                <div>
                    <h3 class="text-sm font-medium text-gray-300 mb-2">Permissions</h3>
                    <div class="grid grid-cols-2 gap-2 text-gray-200">
                        <label class="flex items-center space-x-2"><input type="checkbox" id="edit-perm-add-staff" class="h-4 w-4"><span>Can Add Staff</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="edit-perm-delete-staff" class="h-4 w-4"><span>Can Delete Staff</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="edit-perm-edit-staff" class="h-4 w-4"><span>Can Edit Staff</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="edit-perm-manage-geofence" class="h-4 w-4"><span>Can Manage Geofences</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="edit-perm-manage-admins" class="h-4 w-4"><span>Can Manage Admins</span></label>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-between">
                <button id="delete-admin-btn" class="px-4 py-2 bg-red-700 text-white rounded-md hover:bg-red-800">Delete Admin</button>
                <div class="space-x-3">
                    <button id="cancel-edit-admin-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Cancel</button>
                    <button id="save-edit-admin-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Staff Info Modal (Updated) -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9999] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg border border-gray-700">
            <h2 class="text-xl font-bold text-white mb-4">Edit Staff Info</h2>
            <input type="hidden" id="edit-staff-id">
            <div class="space-y-4">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-staff-name" class="block text-sm font-medium text-gray-300">Name</label>
                        <input type="text" id="edit-staff-name" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                    </div>
                    <div>
                        <label for="edit-staff-phone" class="block text-sm font-medium text-gray-300">Phone Number (10 Digits)</label>
                        <input type="tel" id="edit-staff-phone" placeholder="e.g., 9876543210" maxlength="10" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                    </div>
                </div>
                
                <div>
                    <label for="edit-staff-company" class="block text-sm font-medium text-gray-300">Company</label>
                    <select id="edit-staff-company" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                        <option value="">Select Company</option>
                        <option value="Toyota">Toyota</option>
                        <option value="Ather">Ather</option>
                        <option value="AMS">AMS</option>
                        <option value="Other">Other (Specify)</option>
                    </select>
                    <input type="text" id="edit-staff-company-other" placeholder="Enter company name" class="mt-2 hidden w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                </div>
                
                <div>
                    <label for="edit-staff-branch" class="block text-sm font-medium text-gray-300">Branch</label>
                    <select id="edit-staff-branch" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                        <option value="">Select Branch</option>
                        <option value="Coimbatore">Coimbatore</option>
                        <option value="Erode">Erode</option>
                        <option value="Tiruppur">Tiruppur</option>
                        <option value="Mettupalayam">Mettupalayam</option>
                        <option value="Udumalpet">Udumalpet</option>
                        <option value="Dharapuram">Dharapuram</option>
                        <option value="Madampatti">Madampatti</option>
                        <option value="Pollachi">Pollachi</option>
                        <option value="Ooty">Ooty</option>
                        <option value="Kangayam">Kangayam</option>
                        <option value="Bhavani">Bhavani</option>
                        <option value="Other">Other (Specify)</option>
                    </select>
                    <input type="text" id="edit-staff-branch-other" placeholder="Enter branch name" class="mt-2 hidden w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                </div>
                
                <div>
                    <label for="edit-staff-dept" class="block text-sm font-medium text-gray-300">Department</label>
                    <select id="edit-staff-dept" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
                        <option value="">Select Department</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Eco Wash">Eco Wash</option>
                        <option value="Towing Service">Towing Service</option>
                        <option value="Driver Service">Driver Service</option>
                        <option value="BrakeDown Service">BrakeDown Service</option>
                        <option value="Other">Other (Specify)</option>
                    </select>
                    <input type="text" id="edit-staff-dept-other" placeholder="Enter department name" class="mt-2 hidden w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                </div>
            </div>
            <!-- Modal Buttons -->
            <div class="mt-6 flex justify-between">
                <button id="delete-staff-btn" class="px-4 py-2 bg-red-700 text-white rounded-md hover:bg-red-800">Delete Staff</button>
                <div class="space-x-3">
                    <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Cancel</button>
                    <button id="save-edit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Save/Edit Geofence Modal -->
    <div id="geofence-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9999] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg border border-gray-700">
            <!-- Modal Title -->
            <h2 id="geofence-modal-title" class="text-xl font-bold text-white mb-4">Create Geofence</h2>
            <!-- Hidden input to store ID for editing -->
            <input type="hidden" id="edit-geofence-id">
            
            <!-- Geofence Name -->
            <div class="mb-4">
                <label for="geofence-name" class="block text-sm font-medium text-gray-300">Geofence Name:</label>
                <input type="text" id="geofence-name" placeholder="e.g., 'Main Worksite'" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
            </div>
            
            <!-- Geofence Staff Assignment -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Assign to Staff:</label>
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="assign-all-staff" class="h-4 w-4 text-purple-600 border-gray-500 rounded focus:ring-purple-500 bg-gray-700">
                    <label for="assign-all-staff" class="ml-2 block text-sm text-gray-200">Assign to All Staff (includes new staff)</label>
                </div>
                <!-- Search within staff list -->
                <div class="mb-2">
                    <input type="text" id="geofence-staff-search" placeholder="Search staff by name, company, branch, dept..." class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                </div>
                <div id="geofence-staff-list" class="geofence-staff-list space-y-1">
                    <!-- Staff checkboxes will be injected here -->
                    <p class="text-gray-400">Loading staff...</p>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-geofence-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Cancel</button>
                <button id="save-geofence-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Message Modal (for confirmations and alerts) -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9999] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm border border-gray-700">
            <h2 id="message-title" class="text-xl font-bold text-white mb-4">Notification</h2>
            <p id="message-text" class="text-gray-300 mb-6">This is a message.</p>
            <div id="message-buttons" class="flex justify-end space-x-3">
                <button id="message-cancel-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500 hidden">Cancel</button>
                <button id="message-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Filter Modal -->
     <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9998] hidden">
         <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-xl border border-gray-700 max-h-[90vh] flex flex-col">
             <h2 class="text-xl font-bold text-white mb-4 flex-shrink-0">Filter Staff View</h2>

             <!-- Filter Content (Scrollable) -->
             <div class="flex-grow overflow-y-auto pr-2 custom-scroll space-y-4">
                 <!-- Company Filter -->
                 <div class="filter-section">
                     <h3>Select Companies</h3>
                     <div id="filter-company-list" class="checkbox-list custom-scroll">
                         <label><input type="checkbox" class="filter-select-all" data-type="company"> Select All</label>
                         <!-- Company options populated by JS -->
                     </div>
                 </div>
                 <!-- Branch Filter -->
                 <div class="filter-section">
                     <h3>Select Branches</h3>
                     <div id="filter-branch-list" class="checkbox-list custom-scroll">
                         <label><input type="checkbox" class="filter-select-all" data-type="branch"> Select All</label>
                         <!-- Branch options populated by JS -->
                     </div>
                 </div>
                 <!-- Department Filter -->
                 <div class="filter-section">
                     <h3>Select Departments</h3>
                     <div id="filter-dept-list" class="checkbox-list custom-scroll">
                          <label><input type="checkbox" class="filter-select-all" data-type="dept"> Select All</label>
                         <!-- Dept options populated by JS -->
                     </div>
                 </div>
                 <!-- Staff Filter -->
                 <div class="filter-section">
                     <h3>Select Staff</h3>
                     <div id="filter-staff-list" class="checkbox-list custom-scroll">
                          <label><input type="checkbox" class="filter-select-all" data-type="staff"> Select All</label>
                         <!-- Staff options populated by JS -->
                     </div>
                 </div>
             </div>

             <!-- Modal Buttons -->
             <div class="mt-6 flex justify-between items-center flex-shrink-0">
                  <button id="clear-filters-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Clear Filters</button>
                 <div class="space-x-3">
                     <button id="cancel-filter-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Cancel</button>
                     <button id="apply-filters-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Apply Filters</button>
                 </div>
             </div>
         </div>
     </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9999] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm border border-gray-700">
            <h2 class="text-xl font-bold text-white mb-2">View History</h2>
            <p class="text-gray-300 mb-4 text-sm">For: <span id="history-staff-name" class="font-bold"></span></p>
            <input type="hidden" id="history-staff-id">
            
            <div class="mb-4">
                <label for="history-date-picker" class="block text-sm font-medium text-gray-300">Select Date:</label>
                <input type="date" id="history-date-picker" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white">
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-history-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Cancel</button>
                <button id="show-history-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Show Path</button>
            </div>
        </div>
    </div>


    <!-- NEW: Day Report Modal -->
    <div id="day-report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[9999] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg border border-gray-700 flex flex-col max-h-[90vh]">
            <h2 class="text-xl font-bold text-white mb-2">Daily Report</h2>
            <p class="text-gray-300 mb-1 text-sm">For: <span id="report-staff-name" class="font-bold"></span></p>
            <p class="text-gray-300 mb-4 text-sm">Date: <span id="report-date" class="font-bold"></span></p>
            <input type="hidden" id="report-staff-id">
            
            <div id="day-report-list" class="custom-scroll flex-grow mb-4">
                <!-- Report items will be injected here -->
                <p class="text-gray-400">Loading report...</p>
            </div>

            <div class="flex justify-end flex-shrink-0">
                <button id="close-report-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded-md hover:bg-gray-500">Close</button>
            </div>
        </div>
    </div>
    


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            onSnapshot, 
            query, 
            where, 
            getDocs,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            Timestamp,
            writeBatch,
            setLogLevel,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- App State ---
        let db, auth;
        let map; // Main map
        let staffMarkers = {}; // Stores { staffId: L.Marker }
        let currentHistoryPath = null; // Stores L.FeatureGroup (line + points)
        let staffDataCache = {}; // Stores { staffId: { id, data, geofenceState: {} } }
        let activeTimeIntervals = {}; // Stores { staffId: intervalId }
        let blueIcon, greyIcon;
        const HEARTBEAT_THRESHOLD_MS = 12 * 60 * 1000; // 12 minutes (aligned with 5‚Äì10 min device cadence)
        const GAP_THRESHOLD_MINS = 30; // 30 minutes (history gap threshold)
        const HISTORY_BUCKET_MINUTES = 15; // Show at most one point per 15 minutes in report and history path
        // UI caches/state
        let locationCache = {}; // { staffId: resolvedAddress }
        let lastPanLatLng = null; // last focused map location
        let tempRouteLine = null; // temporary line between last and next focus
        
        // Geofence State
        let geofencesCache = {}; // Stores { id: { name, center, radius, layer, assignedStaff: [] } }
        let drawnItems; // Layer group for drawn geofences
        let drawControl; // Leaflet.draw controller
        let tempGeofenceData; // Holds new fence data before saving
        
        // Filter State - Holds the currently APPLIED filters
        let currentFilterState = {
            companies: new Set(),
            branches: new Set(),
            departments: new Set(),
            staffIds: new Set()
        };
        // Temporary state for the modal while selections are being made
        let tempFilterState = { 
            companies: new Set(), 
            branches: new Set(), 
            departments: new Set(), 
            staffIds: new Set()
        };
        let isFilterModalOpen = false; 
        
        // Master lists (dynamic, persisted in Firestore)
        let MASTER_COMPANIES = ['Toyota','Ather','AMS'];
        let MASTER_BRANCHES = ['Coimbatore','Erode','Tiruppur','Mettupalayam','Udumalpet','Dharapuram','Madampatti','Pollachi','Ooty','Kangayam','Bhavani'];
        let MASTER_DEPARTMENTS = ['Marketing','Insurance','Eco Wash','Towing Service','Driver Service','BrakeDown Service'];

        // Auth & Role State
        let isSuperAdmin = false;
        let userRole = null; // "master" or "admin"
        let userDepartments = []; // For admin filtering
        let currentAdminName = '';
        let adminPermissions = {}; // { canAddStaff, canDeleteStaff, ... }

        // --- Constants ---
        const PROTECTED_SUPER_ADMIN_ID = 'digital_service_in'; // DO NOT allow editing/deleting this admin

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyCzwX3d7NwtKc209p5DJwPlSedKBUu3nkQ",
          authDomain: "itrack-staff.firebaseapp.com",
          projectId: "itrack-staff",
          storageBucket: "itrack-staff.firebasestorage.app",
          messagingSenderId: "939818786879",
          appId: "1:939818786879:web:4ed8c43dc732579191588a",
          measurementId: "G-M0HGZ7W663"
        };
        
        const staffCollectionPath = `staff`;
        const geofenceCollectionPath = `geofences`;
        
        // --- UI Elements ---
        const connectionStatusEl = document.getElementById('connection-status');
        const staffListEl = document.getElementById('staff-list');
        const loadingStaffEl = document.getElementById('loading-staff');
        
        // Login UI
        const loginPage = document.getElementById('login-page');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const loginError = document.getElementById('login-error');

        // Add Staff Modal UI
        const addStaffSection = document.getElementById('add-staff-section');
        const addStaffModal = document.getElementById('add-staff-modal');
        const openAddStaffModalBtn = document.getElementById('open-add-staff-modal-btn');
        const newStaffNameInput = document.getElementById('new-staff-name');
        const newStaffPhoneInput = document.getElementById('new-staff-phone');
        const newStaffCompanySelect = document.getElementById('new-staff-company');
        const newStaffCompanyOther = document.getElementById('new-staff-company-other');
        const newStaffBranchSelect = document.getElementById('new-staff-branch');
        const newStaffBranchOther = document.getElementById('new-staff-branch-other');
        const newStaffDeptSelect = document.getElementById('new-staff-dept');
        const newStaffDeptOther = document.getElementById('new-staff-dept-other');
        const cancelAddStaffBtn = document.getElementById('cancel-add-staff-btn');
        const addStaffBtn = document.getElementById('add-staff-btn');
        
        // Edit Staff Modal UI
        const editModal = document.getElementById('edit-modal');
        const editStaffIdInput = document.getElementById('edit-staff-id');
        const editStaffNameInput = document.getElementById('edit-staff-name');
        const editStaffPhoneInput = document.getElementById('edit-staff-phone');
        const editStaffCompanySelect = document.getElementById('edit-staff-company');
        const editStaffCompanyOther = document.getElementById('edit-staff-company-other');
        const editStaffBranchSelect = document.getElementById('edit-staff-branch');
        const editStaffBranchOther = document.getElementById('edit-staff-branch-other');
        const editStaffDeptSelect = document.getElementById('edit-staff-dept');
        const editStaffDeptOther = document.getElementById('edit-staff-dept-other');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const deleteStaffBtn = document.getElementById('delete-staff-btn');
        
        
        // Geofence Modal UI
        const geofenceModal = document.getElementById('geofence-modal');
        const geofenceModalTitle = document.getElementById('geofence-modal-title');
        const editGeofenceIdInput = document.getElementById('edit-geofence-id');
        const geofenceNameInput = document.getElementById('geofence-name');
        const cancelGeofenceBtn = document.getElementById('cancel-geofence-btn');
        const saveGeofenceBtn = document.getElementById('save-geofence-btn');
        const assignAllStaffCheckbox = document.getElementById('assign-all-staff');
        const geofenceStaffListEl = document.getElementById('geofence-staff-list');
        const geofenceStaffSearchInput = document.getElementById('geofence-staff-search');
        
        // Message Modal UI
        const messageModal = document.getElementById('message-modal');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const messageButtonsEl = document.getElementById('message-buttons');
        let messageOkBtn = document.getElementById('message-ok-btn');
        let messageCancelBtn = document.getElementById('message-cancel-btn');
        
        // Geofence UI
        const createGeofenceBtn = document.getElementById('create-geofence-btn');
        const geofenceListEl = document.getElementById('geofence-list');
        const loadingGeofencesEl = document.getElementById('loading-geofences');
        
        // Search Bar UI
        const searchInput = document.getElementById('search-input');
        const searchResultsEl = document.getElementById('search-results');
        
        // Filter Modal UI
        const filterIconBtn = document.getElementById('filter-icon-btn');
        const filterModal = document.getElementById('filter-modal');
        const filterCompanyList = document.getElementById('filter-company-list');
        const filterBranchList = document.getElementById('filter-branch-list');
        const filterDeptList = document.getElementById('filter-dept-list');
        const filterStaffList = document.getElementById('filter-staff-list');
        const cancelFilterBtn = document.getElementById('cancel-filter-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        // Clear History Path UI
        const clearPathBtn = document.getElementById('clear-path-btn');
        
        // History Modal UI
        const historyModal = document.getElementById('history-modal');
        const historyStaffIdInput = document.getElementById('history-staff-id');
        const historyStaffNameEl = document.getElementById('history-staff-name');
        const historyDatePicker = document.getElementById('history-date-picker');
        const cancelHistoryBtn = document.getElementById('cancel-history-btn');
        const showHistoryBtn = document.getElementById('show-history-btn');

        // Day Report Modal UI
        const dayReportModal = document.getElementById('day-report-modal');
        const reportStaffNameEl = document.getElementById('report-staff-name');
        const reportDateEl = document.getElementById('report-date');
        const dayReportListEl = document.getElementById('day-report-list');
        const closeReportBtn = document.getElementById('close-report-btn');


        // Admin Modal UI
        const adminControlsSection = document.getElementById('admin-controls');
        const addAdminModal = document.getElementById('add-admin-modal');
        const openAddAdminModalBtn = document.getElementById('open-add-admin-modal-btn');
        const cancelAddAdminBtn = document.getElementById('cancel-add-admin-btn');
        const addAdminBtn = document.getElementById('add-admin-btn');
        const newAdminNameInput = document.getElementById('new-admin-name');
        const newAdminEmailInput = document.getElementById('new-admin-email');
        const newAdminPasswordInput = document.getElementById('new-admin-password');
        const newAdminRoleSelect = document.getElementById('new-admin-role');
        const departmentsSection = document.getElementById('departments-section');
        const departmentsCheckboxes = document.getElementById('departments-checkboxes');
        const permAddStaff = document.getElementById('perm-add-staff');
        const permDeleteStaff = document.getElementById('perm-delete-staff');
        const permEditStaff = document.getElementById('perm-edit-staff');
        const permManageGeofence = document.getElementById('perm-manage-geofence');
        const permManageAdmins = document.getElementById('perm-manage-admins');

        // Logout UI
        const logoutBtn = document.getElementById('logout-btn');
        const adminInfoEl = document.getElementById('admin-info');

        // Manage Admins UI
        const openManageAdminsBtn = document.getElementById('open-manage-admins-btn');
        const closeManageAdminsBtn = document.getElementById('close-manage-admins-btn');
        const manageAdminsModal = document.getElementById('manage-admins-modal');
        const adminsList = document.getElementById('admins-list');

        const editAdminModal = document.getElementById('edit-admin-modal');
        const editAdminId = document.getElementById('edit-admin-id');
        const editAdminName = document.getElementById('edit-admin-name');
        const editAdminEmail = document.getElementById('edit-admin-email');
        const editAdminRole = document.getElementById('edit-admin-role');
        const editDepartmentsCheckboxes = document.getElementById('edit-departments-checkboxes');
        const saveEditAdminBtn = document.getElementById('save-edit-admin-btn');
        const deleteAdminBtn = document.getElementById('delete-admin-btn');
        const cancelEditAdminBtn = document.getElementById('cancel-edit-admin-btn');

        // --- Helper Functions ---
        function escapeHTML(s) { return String(s==null?'':s).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#039;'})[m]); } 
        function escapeAttr(s) { return String(s==null?'':s).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#039;'})[m]); }
        function formatDuration(s) { s=Math.floor(s||0); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; const p=n=>String(n).padStart(2,'0'); return `${p(h)}:${p(m)}:${p(sec)}`; } 
        function formatTimestamp(ts) { if (!ts) return "N/A"; try { return ts.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); } catch(e){ return "Invalid"; } }
        // deterministic tiny hash -> 0..n-1
        function hashSlot(str, slots){ let h=0; for(let i=0;i<str.length;i++){ h=(h*31 + str.charCodeAt(i))|0; } h=Math.abs(h); return h%slots; }
        function getLabelOffsetForId(id){
            // Keep a constant vertical offset above the marker tip (~41px icon height)
            const Y = -44; // fixed vertical lift so label sits just above the marker
            const X_OPTIONS = [-18,-12,-6,0,6,12,18]; // small horizontal jitter only
            const x = X_OPTIONS[hashSlot(String(id||''), X_OPTIONS.length)];
            return [x, Y];
        }
        
        // Small helpers for master list updates/UI refresh
        function isVisible(el){ return !!el && !el.classList.contains('hidden'); }
        function addToLocalMasterLists(company, branch, dept){
            const add = (arr, v) => { if (v && !arr.includes(v)) arr.push(v); };
            add(MASTER_COMPANIES, company); add(MASTER_BRANCHES, branch); add(MASTER_DEPARTMENTS, dept);
            // refresh UIs if open
            if (isVisible(document.getElementById('add-admin-modal'))) populateDepartmentsCheckboxes();
            if (isVisible(document.getElementById('edit-admin-modal'))) rebuildEditDepartmentsCheckboxesFromCurrentSelection();
            if (isFilterModalOpen) populateFilterModal();
        }
        function rebuildEditDepartmentsCheckboxesFromCurrentSelection(){
            if (!editDepartmentsCheckboxes) return;
            const selected = new Set();
            editDepartmentsCheckboxes.querySelectorAll('input[type="checkbox"]:checked').forEach(cb=>selected.add(cb.value));
            editDepartmentsCheckboxes.innerHTML = '';
            [...MASTER_DEPARTMENTS].sort().forEach(dept => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-gray-200 cursor-pointer';
                label.innerHTML = `
                    <input type=\"checkbox\" value=\"${escapeAttr(dept)}\" class=\"edit-department-checkbox h-4 w-4\" ${selected.has(dept)?'checked':''}>
                    <span>${escapeHTML(dept)}</span>
                `;
                editDepartmentsCheckboxes.appendChild(label);
            });
        }
        
        // Update all Company/Branch/Dept selects from master lists
        function refreshCompanyBranchDeptSelects(){
            const update = (selectEl, items, placeholder, currentValue) => {
                if (!selectEl) return;
                const val = currentValue ?? selectEl.value;
                const opts = [ `<option value=\"\">${placeholder}</option>`, ...items.map(v=>`<option value=\"${escapeAttr(v)}\">${escapeHTML(v)}</option>`), `<option value=\"Other\">Other (Specify)</option>` ];
                selectEl.innerHTML = opts.join('');
                // try to restore selection
                if (val && items.includes(val)) selectEl.value = val; else if (val && !items.includes(val) && val !== 'Other') selectEl.value = 'Other';
            };
            update(newStaffCompanySelect, [...MASTER_COMPANIES].sort(), 'Select Company');
            update(newStaffBranchSelect, [...MASTER_BRANCHES].sort(), 'Select Branch');
            update(newStaffDeptSelect, [...MASTER_DEPARTMENTS].sort(), 'Select Department');
            update(editStaffCompanySelect, [...MASTER_COMPANIES].sort(), 'Select Company');
            update(editStaffBranchSelect, [...MASTER_BRANCHES].sort(), 'Select Branch');
            update(editStaffDeptSelect, [...MASTER_DEPARTMENTS].sort(), 'Select Department');
        }
        
        // Load master lists from Firestore (with defaults) and live-update
        async function loadMasterLists(){
            if (!db) return;
            const ref = doc(db, 'settings', 'masterLists');
            try {
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    const data = snap.data() || {};
                    if (Array.isArray(data.companies) && data.companies.length) MASTER_COMPANIES = data.companies;
                    if (Array.isArray(data.branches) && data.branches.length) MASTER_BRANCHES = data.branches;
                    if (Array.isArray(data.departments) && data.departments.length) MASTER_DEPARTMENTS = data.departments;
                } else {
                    // seed with defaults
                    await setDoc(ref, { companies: MASTER_COMPANIES, branches: MASTER_BRANCHES, departments: MASTER_DEPARTMENTS }, { merge: true });
                }
                refreshCompanyBranchDeptSelects();
                // live updates
                onSnapshot(ref, (docSnap)=>{
                    const data = docSnap.data() || {};
                    if (Array.isArray(data.companies)) MASTER_COMPANIES = data.companies;
                    if (Array.isArray(data.branches)) MASTER_BRANCHES = data.branches;
                    if (Array.isArray(data.departments)) MASTER_DEPARTMENTS = data.departments;
                    refreshCompanyBranchDeptSelects();
                    if (isFilterModalOpen) populateFilterModal();
                    if (isVisible(document.getElementById('add-admin-modal'))) populateDepartmentsCheckboxes();
                    if (isVisible(document.getElementById('edit-admin-modal'))) rebuildEditDepartmentsCheckboxesFromCurrentSelection();
                });
            } catch(e){ console.warn('loadMasterLists failed:', e); }
        }

        // Ensure a default Super Admin exists in the admins collection
        async function ensureDefaultSuperAdmin(){
            try {
                if (!db) return;
                const email = 'digital@service.in';
                const password = 'passwayTsmart25';
                const adminId = email.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const ref = doc(db, 'admins', adminId);
                const snap = await getDoc(ref);
                if (!snap.exists()) {
                    await setDoc(ref, {
                        name: 'Super Admin',
                        email,
                        password,
                        role: 'master',
                        departments: [],
                        permissions: {
                            canAddStaff: true,
                            canDeleteStaff: true,
                            canEditStaff: true,
                            canManageGeofence: true,
                            canManageAdmins: true,
                        },
                        createdBy: null,
                        createdAt: Timestamp.now(),
                    });
                    console.log('Default Super Admin created');
                }
            } catch (e) {
                console.warn('ensureDefaultSuperAdmin failed:', e);
            }
        }

        // --- Login System ---
        
        // Toggle password visibility
        if (togglePasswordBtn) {
            togglePasswordBtn.addEventListener('click', () => {
                const isPwd = loginPassword.type === 'password';
                loginPassword.type = isPwd ? 'text' : 'password';
            });
        }

        // Handle login
        if (loginBtn) {
            loginBtn.addEventListener('click', handleLogin);
            if (loginEmail) loginEmail.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            if (loginPassword) loginPassword.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
        }

        async function handleLogin() {
            // Ensure Firestore is initialized before using collection/doc
            if (!db) {
                await initializeAuth();
                if (!db) {
                    showLoginError('Database not initialized. Please try again.');
                    return;
                }
            }
            const email = (loginEmail?.value || '').trim();
            const password = (loginPassword?.value || '').trim();
            
            if (!email || !password) {
                showLoginError('Please enter email and password.');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            
            try {
                let adminSnap = null;
                let adminId = null;
                let adminData = null;
                
                // First, try to find by email-based ID (new format)
                const emailBasedId = email.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                adminSnap = await getDoc(doc(db, 'admins', emailBasedId));
                
                if (adminSnap.exists()) {
                    adminId = emailBasedId;
                    adminData = adminSnap.data();
                } else {
                    // If not found, search all admins collection for matching email
                    const adminsSnap = await getDocs(collection(db, 'admins'));
                    for (const doc of adminsSnap.docs) {
                        const data = doc.data();
                        if (data.email === email) {
                            adminId = doc.id;
                            adminData = data;
                            break;
                        }
                    }
                }
                
                if (!adminId || !adminData) {
                    throw new Error('Admin account not found.');
                }
                
                // Verify password matches
                if (adminData.password !== password) {
                    throw new Error('Invalid password.');
                }
                
                // Set up user session data
                userRole = adminData.role; // "master" or "admin"
                isSuperAdmin = userRole === 'master';
                userDepartments = adminData.departments || [];
                currentAdminName = adminData.name || email;
                adminPermissions = adminData.permissions || {};
                
                // Store admin ID in sessionStorage for persistence
                sessionStorage.setItem('adminId', adminId);
                sessionStorage.setItem('adminEmail', email);
                sessionStorage.setItem('adminRole', userRole);
                
                // Update status
                if (connectionStatusEl) { 
                    connectionStatusEl.textContent = "Connected.";
                    connectionStatusEl.classList.replace('text-red-400', 'text-green-400');
                }
                
                // Initialize dashboard listeners
                updateAdminControlsVisibility();
                listenForStaffUpdates();
                listenForGeofenceUpdates();
                
                // ONLY HIDE LOGIN AFTER SUCCESSFUL AUTHENTICATION
                if (loginPage) loginPage.classList.add('hidden');
                
                // Clear inputs
                if (loginEmail) loginEmail.value = '';
                if (loginPassword) loginPassword.value = '';
                
                showMessage('Success', `Welcome, ${currentAdminName}!`);
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginError(error.message || 'Login failed. Check credentials.');
                // Make sure login page is visible on error
                if (loginPage) loginPage.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        function showLoginError(msg) {
            if (loginError) {
                loginError.textContent = msg;
                loginError.classList.remove('hidden');
                setTimeout(() => loginError.classList.add('hidden'), 5000);
            }
        }

        // --- Initialize Map ---
        function initializeMap() {
            // Start closer in; allow higher zoom levels
            map = L.map('map', { maxZoom: 20, minZoom: 2 }).setView([11.0168, 76.9558], 15);

            // Base layers
            const osmStd = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 20,
                attribution: '&copy; OpenStreetMap contributors'
            });
            const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19,
                attribution: 'Tiles 
